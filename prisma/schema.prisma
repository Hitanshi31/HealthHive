// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  patientCode   String?   @unique // Short ID e.g. HH-7F3A2
  password_hash String
  role          String    // "PATIENT" or "DOCTOR"
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Patient specific relations
  medicalRecords   MedicalRecord[]
  prescriptions    Prescription[]
  emergencyProfile EmergencyProfile?
  sentConsents     Consent[]         @relation("PatientConsents")
  auditLogs        AuditLog[]        @relation("PatientAuditLogs")

  // Doctor specific relations
  receivedConsents Consent[] @relation("DoctorConsents")
}

model MedicalRecord {
  id          String   @id @default(uuid())
  patientId   String
  patient     User     @relation(fields: [patientId], references: [id])
  type        String   // LAB, REPORT, PRESCRIPTION_DOC
  filePath    String?
  summary     String?  // AI generated summary
  source      String?  // Hospital or Lab name
  isComplete  Boolean  @default(true)
  uploadedAt  DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Prescription {
  id            String   @id @default(uuid())
  patientId     String
  patient       User     @relation(fields: [patientId], references: [id])
  medicineName  String
  startDate     DateTime
  endDate       DateTime?
  prescribedBy  String
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model EmergencyProfile {
  id                String   @id @default(uuid())
  patientId         String   @unique
  patient           User     @relation(fields: [patientId], references: [id])
  bloodGroup        String
  allergies         String   // Stored as JSON string or text
  chronicConditions String   // Stored as JSON string or text
  activeMedications String   // Stored as JSON string or text
  qrToken           String   @unique
  expiresAt         DateTime
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

model Consent {
  id         String   @id @default(uuid())
  patientId  String
  patient    User     @relation("PatientConsents", fields: [patientId], references: [id])
  doctorId   String
  doctor     User     @relation("DoctorConsents", fields: [doctorId], references: [id])
  validFrom  DateTime
  validUntil DateTime
  status     String   // ACTIVE, REVOKED
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model AuditLog {
  id         String   @id @default(uuid())
  actorId    String?  // Nullable for anonymous emergency access
  patientId  String
  patient    User     @relation("PatientAuditLogs", fields: [patientId], references: [id])
  action     String   // VIEW, UPLOAD, REVOKE
  resource   String   // RECORD, PRESCRIPTION, EMERGENCY_PROFILE
  purpose    String   // ROUTINE_CARE, EMERGENCY, PATIENT_REQUEST
  details    String?
  timestamp  DateTime @default(now())
}
